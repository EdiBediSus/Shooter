<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FPS Shooter - Multiplayer FIXED</title>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{overflow:hidden;background:#000;font-family:Courier New,monospace}
.hide{display:none!important}
#setupScreen{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:#000c;color:#fff;z-index:10}
#setupScreen div{border:2px solid #0f8;padding:40px;text-align:center}
#hud{position:absolute;bottom:30px;left:50%;transform:translateX(-50%);display:flex;gap:40px;color:#0f8;font-size:20px;z-index:5}
#crosshair{position:absolute;top:50%;left:50%;width:20px;height:20px;transform:translate(-50%,-50%);z-index:5}
.ch{position:absolute;background:#fff}
.ch.v{width:2px;height:8px;left:50%;transform:translateX(-50%)}
.ch.h{height:2px;width:8px;top:50%;transform:translateY(-50%)}
</style>
</head>

<body>

<div id="setupScreen">
  <div>
    <h2>ðŸŽ® MULTIPLAYER FPS</h2><br>
    <input id="playerName" placeholder="Name"><br><br>
    <button onclick="joinGame()">JOIN</button>
  </div>
</div>

<div id="hud" class="hide">
  HP <span id="hp">100</span>
</div>

<div id="crosshair" class="hide">
  <div class="ch v" style="top:-10px"></div>
  <div class="ch v" style="bottom:-10px"></div>
  <div class="ch h" style="left:-10px"></div>
  <div class="ch h" style="right:-10px"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* â”€â”€â”€â”€â”€ SUPABASE â”€â”€â”€â”€â”€ */
const SB_URL="https://rfqptvsdrjaefbxfcctn.supabase.co";
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmcXB0dnNkcmphZWZieGZjY3RuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1NDAyNDYsImV4cCI6MjA4MzExNjI0Nn0.-R1KLz-zEzf3TmxjobxVrfC_Q2S-ya2fnvXGwgPW0h8";
const sb=supabase.createClient(SB_URL,SB_KEY);

/* â”€â”€â”€â”€â”€ GAME VARS â”€â”€â”€â”€â”€ */
let sc,cm,rd,lk=false;
let fw=0,bk=0,lf=0,rt=0;
let yaw=0,pitch=0;
let pid,pname;
let op={};

/* â”€â”€â”€â”€â”€ JOIN â”€â”€â”€â”€â”€ */
async function joinGame(){
 pname=document.getElementById("playerName").value||"Player";
 pid="p_"+Math.random().toString(36).slice(2,9);

 document.getElementById("setupScreen").classList.add("hide");
 document.getElementById("hud").classList.remove("hide");
 document.getElementById("crosshair").classList.remove("hide");

 init();

 await sb.from("players").insert({
   id:pid,name:pname,x:0,y:1.7,z:0,yaw:0,pitch:0
 });

 sb.channel("game")
 .on("postgres_changes",{event:"*",schema:"public",table:"players"},e=>{
   if(e.new && e.new.id!==pid) upOP(e.new);
   if(e.old && !e.new) rmOP(e.old.id);
 })
 .subscribe();

 setInterval(updateMe,50);

 rd.domElement.requestPointerLock();
 document.addEventListener("pointerlockchange",()=>lk=document.pointerLockElement===rd.domElement);
}

/* â”€â”€â”€â”€â”€ INIT â”€â”€â”€â”€â”€ */
function init(){
 sc=new THREE.Scene();
 sc.background=new THREE.Color(0x87ceeb);

 cm=new THREE.PerspectiveCamera(80,innerWidth/innerHeight,0.1,500);
 cm.position.set(0,1.7,0);

 rd=new THREE.WebGLRenderer({antialias:true});
 rd.setSize(innerWidth,innerHeight);
 document.body.appendChild(rd.domElement);

 sc.add(new THREE.AmbientLight(0xffffff,0.8));

 const floor=new THREE.Mesh(
   new THREE.PlaneGeometry(100,100),
   new THREE.MeshStandardMaterial({color:0x3a7d3a})
 );
 floor.rotation.x=-Math.PI/2;
 sc.add(floor);

 document.addEventListener("mousemove",e=>{
   if(!lk) return;
   yaw-=e.movementX*0.002;
   pitch=Math.max(-1.5,Math.min(1.5,pitch-e.movementY*0.002));
 });

 document.addEventListener("keydown",e=>{
   if(e.code==="KeyW")fw=1;
   if(e.code==="KeyS")bk=1;
   if(e.code==="KeyA")lf=1;
   if(e.code==="KeyD")rt=1;
 });

 document.addEventListener("keyup",e=>{
   if(e.code==="KeyW")fw=0;
   if(e.code==="KeyS")bk=0;
   if(e.code==="KeyA")lf=0;
   if(e.code==="KeyD")rt=0;
 });

 animate();
}

/* â”€â”€â”€â”€â”€ UPDATE SELF â”€â”€â”€â”€â”€ */
async function updateMe(){
 if(!cm) return;
 await sb.from("players").update({
   x:cm.position.x,
   y:cm.position.y,
   z:cm.position.z,
   yaw:yaw,
   pitch:pitch
 }).eq("id",pid);
}

/* â”€â”€â”€â”€â”€ OTHER PLAYERS â”€â”€â”€â”€â”€ */
function upOP(d){
 if(!op[d.id]){
   const mesh=new THREE.Mesh(
     new THREE.BoxGeometry(1,2,1),
     new THREE.MeshStandardMaterial({color:0x3366ff})
   );
   sc.add(mesh);
   op[d.id]={
     mesh,
     targetPos:new THREE.Vector3(),
     targetYaw:0,
     targetPitch:0
   };
 }

 op[d.id].targetPos.set(d.x,d.y-1,d.z);
 op[d.id].targetYaw=d.yaw;
 op[d.id].targetPitch=d.pitch;
}

function rmOP(id){
 if(op[id]){
   sc.remove(op[id].mesh);
   delete op[id];
 }
}

/* â”€â”€â”€â”€â”€ LOOP â”€â”€â”€â”€â”€ */
function animate(){
 requestAnimationFrame(animate);

 let dir=new THREE.Vector3();
 if(fw)dir.z-=1;
 if(bk)dir.z+=1;
 if(lf)dir.x-=1;
 if(rt)dir.x+=1;

 if(dir.length()){
   dir.normalize().applyQuaternion(cm.quaternion);
   dir.y=0;
   cm.position.add(dir.multiplyScalar(0.15));
 }

 cm.quaternion.setFromEuler(new THREE.Euler(pitch,yaw,0,"YXZ"));

 for(const p of Object.values(op)){
   p.mesh.position.lerp(p.targetPos,0.25);
   p.mesh.rotation.y+=(-p.targetYaw-p.mesh.rotation.y)*0.25;
 }

 rd.render(sc,cm);
}
</script>
</body>
</html>
